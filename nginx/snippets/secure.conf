# ============================================================================
# SECURITY RULES - Include in server context
# Uses map variables for optimal performance
# ============================================================================

# Block requests flagged by security maps
# Cookie overflow returns 413 (Payload Too Large)
if ($block_overflow = 1) {
    return 413;
}

# All other security violations return 403
if ($block_request = 1) {
    return 403;
}

# ============================================================================
# URL PATTERN BLOCKS - Location-based security
# ============================================================================

# Block Nginx/Apache status pages (return 403, not 404)
location ~* ^/(server-status|nginx_status|status|server-info|info\.php|phpinfo\.php|php-fpm-status|fpm-status|apc\.php|opcache\.php)$ {
    deny all;
}

# ============================================================================
# INTERNAL ENDPOINTS PROTECTION (H2C Smuggling Prevention)
# Block common internal endpoints used in H2C smuggling attacks
# ============================================================================

# Kubernetes/Container internal endpoints
location ~* ^/(internal|metrics|health|healthz|ready|readiness|liveness)(/|$) {
    deny all;
}

# Debug and monitoring endpoints
location ~* ^/(debug|actuator|prometheus|grafana)(/|$) {
    deny all;
}

# Kubernetes API paths (should never be exposed)
location ~* ^/api(s)?/v[0-9]+/(nodes|pods|services|namespaces|secrets|configmaps) {
    deny all;
}

# Block .env files (common misconfiguration)
location ~* /\.env {
    deny all;
}

# Block paths with double slashes (normalization bypass attempts)
location ~* "^.*//+.*$" {
    return 403;
}

# Block suspicious patterns in URL
location ~* "(base64_encode)(.*)\(" { deny all; }
location ~* "eval\(" { deny all; }
location ~* "127\.1" { deny all; }
location ~* "127\.0\.1" { deny all; }
location ~* "127\.0\.0\.1" { deny all; }
location ~* "[a-z0-9]{2000}" { deny all; }
location ~* "javascript:.*;" { deny all; }
location ~* "(GLOBALS|REQUEST)(=|\[|%)" { deny all; }
location ~* "(<|%3C).*script.*(>|%3E)" { deny all; }
location ~ "(\\|\.\.\.|\.\./|~|`|<|>|\|)" { deny all; }
location ~* "(boot\.ini|etc/passwd|self/environ)" { deny all; }
location ~* "(thumbs?(_editor|open)?|tim(thumb)?)\.php" { deny all; }
location ~* "('|\")(.*)(drop|insert|md5|select|union)" { deny all; }
location ~* "(https?|ftp|php):/" { deny all; }
location ~* "(=\\'|=%27|/\\'/?)\." { deny all; }
location ~ "(\{0\}|\(/\(|\.\.\.|\+\+\+|\"\")" { deny all; }
location ~ "(~|`|<|>|:|;|%|\\|\s|\{|\}|\[|\]|\|)" { deny all; }
location ~* "/(=|\$&|_mm|(wp-)?config\.|cgi-|etc/passwd|muieblack)" { deny all; }

# ============================================================================
# FILE EXTENSION BLOCKS
# ============================================================================

# Deny backup extensions & log files
location ~* "\.(old|orig|original|php#|php~|php_bak|save|swo|aspx?|tpl|sh|bash|bak?|cfg|cgi|dll|exe|git|hg|ini|jsp|log|mdb|out|sql|svn|swp|tar|rdf|gz|zip|bz2|7z|pem|asc|conf|dump)$" {
    deny all;
}

# Return 403 for readme/license files
location ~* "/(^$|readme|license|example|README|LEGALNOTICE|INSTALLATION|CHANGELOG)\.(txt|html|md)" {
    deny all;
}

# Deny hidden files (except .well-known)
location ~ /\.(?!well-known/) {
    deny all;
}

# ============================================================================
# WORDPRESS SPECIFIC BLOCKS
# ============================================================================

# WordPress: deny sensitive files
location ~* ^/(?:wp-links-opml\.php|wp-config\.php|wp-config-sample\.php)$ {
    deny all;
}

# Block WordPress installation and upgrade scripts (prevent reinstall/unauthorized upgrade attacks)
location ~* ^/wp-admin/(install|upgrade)\.php$ {
    deny all;
}

location = /wp-config.txt {
    deny all;
    access_log off;
    log_not_found off;
}

# WordPress: deny wp-content, wp-includes php files
location ~* ^/(?:wp-content|wp-includes)/.*\.php$ {
    deny all;
}

# Deny PHP in uploads directory
location ~* /(?:uploads|files)/.*\.php$ {
    deny all;
}

# Mitigate DoS with WordPress script concatenation
location ~ /wp-admin/load-(scripts|styles).php {
    deny all;
}
