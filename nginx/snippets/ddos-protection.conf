# ============================================================================
# DDOS PROTECTION SNIPPET
# Include this in your server{} block for additional DDoS protection
# ============================================================================

# ============================================================================
# EMERGENCY RATE LIMITS (Uncomment during active attack)
# ============================================================================

# During a DDoS attack, uncomment these to enable very strict limits:
# limit_req zone=strict burst=1 nodelay;
# limit_conn conn_per_ip 5;

# ============================================================================
# COMMON ATTACK VECTORS PROTECTION
# ============================================================================

# Block common DDoS amplification/reflection endpoints
location ~* ^/(xmlrpc\.php|wp-trackback\.php)$ {
    # Very strict rate limit - 1 request per 2 seconds
    limit_req zone=strict burst=1 nodelay;
    
    # Block if not Jetpack (uncomment to enable)
    # if ($http_user_agent !~* "Jetpack") {
    #     return 403;
    # }
    
    include snippets/fastcgi-php.conf;
    fastcgi_pass php{{PHP_VERSION_NO_DOT}}_other;
}

# Block direct access to PHP files that shouldn't be accessed directly
location ~* ^/wp-content/.*\.php$ {
    deny all;
}

# ============================================================================
# BOT/CRAWLER PROTECTION
# ============================================================================

# Block empty user agents (common in automated attacks)
if ($http_user_agent = "") {
    return 444;
}

# Block specific bad bots (add more as needed)
if ($http_user_agent ~* "(Indy|Morfeus|ZmEu|Nikto|sqlmap|Acunetix|Nessus)") {
    return 444;
}

# ============================================================================
# SUSPICIOUS REQUEST PATTERNS
# ============================================================================

# Block requests with excessively long URIs (potential buffer overflow/DoS)
if ($request_uri ~* "^.{2048,}") {
    return 414;
}

# Block requests with too many query parameters
if ($query_string ~* "(&[^&]+){50,}") {
    return 400;
}

# ============================================================================
# GEO-BASED BLOCKING (Optional - requires GeoIP module)
# ============================================================================

# Uncomment and configure based on your needs:
# if ($blocked_country = 1) {
#     return 444;
# }

# if ($blocked_ip = 1) {
#     return 444;
# }
