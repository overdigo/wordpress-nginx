# =============================================================================
# FASTCGI CACHE CONFIGURATION
# =============================================================================
# High-performance page cache for WordPress
# Include this in the http context of nginx.conf
# =============================================================================

# -----------------------------------------------------------------------------
# CACHE ZONE DEFINITION (IN-MEMORY usando tmpfs/RAM)
# -----------------------------------------------------------------------------
# path: /dev/shm/nginx-cache - Cache em RAM (tmpfs) para máxima performance
# levels: 1:2 - Estrutura de diretórios (evita muitos arquivos em um diretório)
# keys_zone: WORDPRESS:100m - 100MB de memória para chaves (suficiente para ~800k URLs)
# inactive: 60m - Remove entradas não acessadas em 60 minutos
# max_size: 256m - Tamanho máximo do cache (ajuste conforme RAM disponível)
# use_temp_path: off - Escreve diretamente no cache (melhor performance)
#
# NOTA: /dev/shm é um tmpfs montado em RAM por padrão no Linux
# Alternativa: criar mount point dedicado com: mount -t tmpfs -o size=512M tmpfs /var/cache/nginx

fastcgi_cache_path /dev/shm/nginx-cache levels=1:2 keys_zone=WORDPRESS:100m inactive=60m max_size=256m use_temp_path=off;

# -----------------------------------------------------------------------------
# CACHE KEY
# -----------------------------------------------------------------------------
# Chave única para cada página. Inclui:
# - scheme: http vs https
# - host: domínio do site
# - request_uri: URL completa incluindo query string
# - request_method: GET, POST, etc (importante para segurança)

fastcgi_cache_key "$scheme$request_method$host$request_uri";

# -----------------------------------------------------------------------------
# CACHE BYPASS FOR LOGGED-IN USERS AND SPECIAL REQUESTS
# -----------------------------------------------------------------------------
# Estas variáveis determinam quando NÃO usar cache

# Bypass se tem cookies de login/comentários
map $http_cookie $skip_cache_cookie {
    default 0;
    ~*wordpress_logged_in 1;      # Usuário logado
    ~*wordpress_sec 1;            # Cookie de segurança
    ~*wp-postpass 1;              # Post protegido por senha
    ~*comment_author 1;           # Autor de comentário recente
    ~*woocommerce_cart_hash 1;    # Carrinho WooCommerce
    ~*woocommerce_items 1;        # Itens WooCommerce
    ~*wp_woocommerce_session 1;   # Sessão WooCommerce
    ~*edd_cart 1;                 # Cart Easy Digital Downloads
    ~*edd_items 1;                # Items Easy Digital Downloads
}

# Bypass para requisições POST (formulários, etc)
map $request_method $skip_cache_method {
    default 0;
    POST 1;
    PUT 1;
    DELETE 1;
}

# Bypass para URLs com query string (exceto algumas seguras)
map $arg_add-to-cart $skip_cache_woocommerce {
    default 0;
    ~.+ 1;
}

# Bypass para páginas dinâmicas do WordPress
map $request_uri $skip_cache_uri {
    default 0;
    ~*/wp-admin 1;                # Admin do WordPress
    ~*/wp-login.php 1;            # Login
    ~*/wp-cron.php 1;             # Cron
    ~*/wp-json 1;                 # REST API
    ~*/xmlrpc.php 1;              # XML-RPC
    ~*sitemap 1;                  # Sitemaps (geralmente dinâmicos)
    ~*/feed 1;                    # Feeds RSS
    ~*/cart 1;                    # Carrinho WooCommerce
    ~*/checkout 1;                # Checkout WooCommerce
    ~*/my-account 1;              # Minha conta WooCommerce
    ~*add-to-cart 1;              # Adicionar ao carrinho
    ~*preview=true 1;             # Preview de posts
    ~*nocache 1;                  # Parâmetro explícito nocache
}

# Variável combinada para bypass
map $skip_cache_cookie$skip_cache_method$skip_cache_uri$skip_cache_woocommerce $skip_cache {
    default 1;
    0000 0;
}

# -----------------------------------------------------------------------------
# CACHE HEADERS FOR DEBUGGING
# -----------------------------------------------------------------------------
# Adiciona header X-FastCGI-Cache para debug (HIT, MISS, BYPASS)
# Cuidado: pode revelar informações em produção

# add_header X-FastCGI-Cache $upstream_cache_status;
