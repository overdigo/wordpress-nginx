# =============================================================================
# FASTCGI CACHE LOCATION RULES
# =============================================================================
# Include this in the server context where you want caching enabled
# Requires: snippets/fastcgi-cache.conf in http context
# =============================================================================

# -----------------------------------------------------------------------------
# CACHE SETTINGS FOR PHP
# -----------------------------------------------------------------------------
# Aplicar cache ao handler PHP

# Ativa o cache na zona WORDPRESS
fastcgi_cache WORDPRESS;

# Quando usar cache (default: apenas 200 302 304)
fastcgi_cache_valid 200 301 60m;      # Páginas OK e redirects: 60 minutos
fastcgi_cache_valid 404 1m;           # Páginas 404: 1 minuto
fastcgi_cache_valid any 1m;           # Outros status: 1 minuto

# Bypass cache baseado nas variáveis do map
fastcgi_cache_bypass $skip_cache;
fastcgi_no_cache $skip_cache;

# Permitir stale content enquanto revalida (melhor UX durante picos)
fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;

# Apenas uma requisição por vez pode popular o cache para cada chave
fastcgi_cache_lock on;
fastcgi_cache_lock_timeout 5s;
fastcgi_cache_lock_age 5s;

# Revalidação em background (não bloqueia o usuário)
fastcgi_cache_background_update on;

# Mínimo de requests para cachear (evita cache de páginas raras)
fastcgi_cache_min_uses 1;

# Ignorar headers do backend que desabilitam cache
# Alguns plugins WordPress enviam headers anti-cache desnecessários
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

# Headers para debug (opcional - descomente para troubleshooting)
# add_header X-FastCGI-Cache $upstream_cache_status always;
# add_header X-Skip-Cache $skip_cache always;
