# =============================================================================
# CLOUDFLARE CACHE HEADERS
# =============================================================================
# Include this in server {} context for WordPress behind Cloudflare
# Controls what Cloudflare caches and for how long
# =============================================================================

# -----------------------------------------------------------------------------
# CACHE CONTROL FOR STATIC ASSETS
# -----------------------------------------------------------------------------
# Browser TTL (Cache-Control) + Cloudflare Edge TTL (CDN-Cache-Control)
#
# s-maxage = Edge cache TTL (Cloudflare respects this)
# max-age  = Browser cache TTL
# stale-while-revalidate = Serve stale while fetching new version
# stale-if-error = Serve stale if origin returns error

# CSS & JS files - aggressive caching (fingerprinted URLs)
location ~* \.(?:css|js)$ {
    add_header Cache-Control "public, max-age=31536000, s-maxage=31536000, immutable";
    add_header CDN-Cache-Control "max-age=31536000";
    add_header Access-Control-Allow-Origin "*";
    access_log off;
    log_not_found off;
}

# Fonts - long cache, CORS required
location ~* \.(?:eot|otf|ttf|woff|woff2)$ {
    add_header Cache-Control "public, max-age=31536000, s-maxage=31536000, immutable";
    add_header CDN-Cache-Control "max-age=31536000";
    add_header Access-Control-Allow-Origin "*";
    access_log off;
    log_not_found off;
}

# Images - long cache with revalidation
location ~* \.(?:jpg|jpeg|gif|png|ico|webp|avif|svg|svgz|bmp|tiff|heic)$ {
    add_header Cache-Control "public, max-age=31536000, s-maxage=31536000, stale-while-revalidate=86400";
    add_header CDN-Cache-Control "max-age=31536000";
    add_header Access-Control-Allow-Origin "*";
    access_log off;
    log_not_found off;
}

# Audio/Video - long cache
location ~* \.(?:mp3|mp4|m4a|ogg|ogv|webm|wav|flac|aac)$ {
    add_header Cache-Control "public, max-age=31536000, s-maxage=31536000";
    add_header CDN-Cache-Control "max-age=31536000";
    add_header Access-Control-Allow-Origin "*";
    access_log off;
    log_not_found off;
}

# Documents - moderate cache
location ~* \.(?:pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf)$ {
    add_header Cache-Control "public, max-age=86400, s-maxage=604800";
    add_header CDN-Cache-Control "max-age=604800";
    access_log off;
    log_not_found off;
}

# -----------------------------------------------------------------------------
# DYNAMIC CONTENT - NO EDGE CACHE
# -----------------------------------------------------------------------------
# Use CDN-Cache-Control: no-store to prevent Cloudflare caching
# Browser can still cache with Cache-Control

# Admin area - no cache anywhere
location /wp-admin/ {
    add_header Cache-Control "no-store, no-cache, must-revalidate, private";
    add_header CDN-Cache-Control "no-store";
    # ... rest of wp-admin config
}

# Login page - no cache
location = /wp-login.php {
    add_header Cache-Control "no-store, no-cache, must-revalidate, private";
    add_header CDN-Cache-Control "no-store";
    # ... rest of login config
}

# AJAX - no edge cache (browser can cache briefly)
location = /wp-admin/admin-ajax.php {
    add_header Cache-Control "no-cache, must-revalidate";
    add_header CDN-Cache-Control "no-store";
    # ... rest of ajax config
}

# REST API - no edge cache by default
location ^~ /wp-json/ {
    add_header Cache-Control "no-cache, must-revalidate";
    add_header CDN-Cache-Control "no-store";
    # ... rest of API config
}

# WooCommerce dynamic pages
location ~* ^/(cart|checkout|my-account)/ {
    add_header Cache-Control "no-store, no-cache, must-revalidate, private";
    add_header CDN-Cache-Control "no-store";
}

# -----------------------------------------------------------------------------
# HTML PAGES - SHORT EDGE CACHE
# -----------------------------------------------------------------------------
# For HTML pages, use short edge cache with long stale times
# This allows fast edge delivery while ensuring fresh content

# General HTML (index.php handled pages)
# Cloudflare: 1 hour edge cache, 24h stale-while-revalidate
# Browser: no-cache (always revalidate)

# In your PHP location block, add:
# add_header Cache-Control "public, max-age=0, s-maxage=3600, stale-while-revalidate=86400";
# add_header CDN-Cache-Control "max-age=3600";
