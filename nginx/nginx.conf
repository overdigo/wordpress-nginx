user www-data;	
worker_processes auto;	
worker_cpu_affinity auto;	
worker_rlimit_nofile 100000;	
pid /run/nginx.pid;	
	
pcre_jit on;	
	
events {	
	multi_accept on;
	worker_connections 50000;
	accept_mutex on;
	use epoll;
}	
	
	
http {	
	keepalive_timeout 60;
	
	# ============================================================================
	# DDOS / DOS PROTECTION
	# ============================================================================
	# Multi-layer protection against volumetric and application-layer attacks
	
	# ---------------------------------------------------------------------------
	# LAYER 1: SLOWLORIS PROTECTION
	# ---------------------------------------------------------------------------
	# Slowloris attacks keep connections open by sending partial requests slowly.
	# These timeouts force clients to send data quickly or get disconnected.
	
	# Time to receive client headers (default: 60s - too long!)
	client_header_timeout 5s;
	
	# Time to receive client body (default: 60s)
	client_body_timeout 10s;
	
	# Time between successive writes to client (default: 60s)
	send_timeout 10s;
	
	# Reset timed out connections (frees up resources faster)
	reset_timedout_connection on;
	
	# ---------------------------------------------------------------------------
	# LAYER 2: CONNECTION LIMITS (Anti-Flood)
	# ---------------------------------------------------------------------------
	# Limit connections per IP to prevent connection exhaustion attacks
	
	# Zone for tracking connections per IP (10m = ~160,000 IPs)
	limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;
	
	# Zone for tracking connections per server (total connections)
	limit_conn_zone $server_name zone=conn_per_server:10m;
	
	# Limit: 10 simultaneous connections per IP
	limit_conn conn_per_ip 10;
	
	# Limit: 100 simultaneous connections per virtual server
	limit_conn conn_per_server 100;
	
	# Return 429 (Too Many Requests) when limit exceeded
	limit_conn_status 429;
	limit_conn_log_level warn;
	
	# ---------------------------------------------------------------------------
	# LAYER 3: REQUEST RATE LIMITING
	# ---------------------------------------------------------------------------
	# Different rate limits for different types of content
	
	# Return 429 when rate limit exceeded
	limit_req_status 429;
	
	# Zone 1: Strict rate limit for login/sensitive endpoints (1 req/sec)
	limit_req_zone $binary_remote_addr zone=strict:10m rate=1r/s;
	
	# Zone 2: Normal rate limit for general pages (10 req/sec)
	limit_req_zone $binary_remote_addr zone=normal:10m rate=10r/s;
	
	# Zone 3: Relaxed rate limit for static assets (50 req/sec)
	limit_req_zone $binary_remote_addr zone=static:10m rate=50r/s;
	
	# Zone 4: API rate limit (5 req/sec with burst)
	limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;
	
	# Zone 5: Search/heavy operations (2 req/sec)
	limit_req_zone $binary_remote_addr zone=search:10m rate=2r/s;
	
	# Zone 6: Per-IP global limit (100 req/sec) - catches aggressive scrapers
	limit_req_zone $binary_remote_addr zone=global:20m rate=100r/s;
	
	# Legacy zones for compatibility (used in nginx.mustache)
	limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
	limit_req_zone $binary_remote_addr zone=two:10m rate=10r/s;
	
	# ---------------------------------------------------------------------------
	# LAYER 4: REQUEST SIZE LIMITS
	# ---------------------------------------------------------------------------
	# Prevent large payload attacks
	
	# Maximum URI length (prevent hash table DoS)
	# Controlled by large_client_header_buffers in BUFFER section
	
	# ---------------------------------------------------------------------------
	# LAYER 5: BLACKLIST SUPPORT (Optional - requires GeoIP or manual lists)
	# ---------------------------------------------------------------------------
	# Uncomment and configure if you have known bad IPs/countries
	
	# geo $blocked_ip {
	#     default 0;
	#     # Add bad IPs here
	#     # 1.2.3.4 1;
	#     # 5.6.7.0/24 1;
	# }
	
	# geo $blocked_country {
	#     default 0;
	#     # Requires GeoIP module
	#     # include /etc/nginx/geo/blocked_countries.conf;
	# }
	
	# ============================================================================
	# PERFORMANCE SETTINGS
	# ============================================================================
	
	# Nginx AIO : See - https://www.nginx.com/blog/thread-pools-boost-performance-9x/
	aio threads;
	
	server_tokens off;
	
	# ============================================================================
	# HARDENING SETTINGS
	# ============================================================================
	
	# Normalize paths with multiple slashes (// -> /)
	merge_slashes on;
	
	# Reject requests with invalid headers
	ignore_invalid_headers on;
	
	# Block headers with underscores (Transfer_Encoding smuggling prevention)
	underscores_in_headers off;
	
	# Remove information disclosure headers
	more_set_headers "X-Pingback:";
	more_set_headers "Link:";
	
	# Proxy Settings
	# set_real_ip_from
	# real_ip_header
	
	fastcgi_read_timeout 300;
	
	# ============================================================================
	# BUFFER OVERFLOW PROTECTION
	# ============================================================================
	# Limit buffer sizes to prevent large payloads from exhausting memory
	# or exploiting buffer overflow vulnerabilities.
	
	# Maximum allowed size of client request body (uploads, POST data)
	client_max_body_size 100m;
	
	# Buffer size for reading client request body
	# If body exceeds this, it's written to temp file (slower but safer)
	client_body_buffer_size 16k;
	
	# Buffer size for reading client request header
	client_header_buffer_size 1k;
	
	# Maximum number and size of buffers for large headers (cookies, long URIs)
	# 4 buffers of 8k = 32k max for headers
	large_client_header_buffers 4 8k;
	
	# Limit URI length (prevents attack via extremely long URIs)
	# Note: This is implicitly limited by large_client_header_buffers
	
	# FastCGI buffer settings (for PHP responses)
	fastcgi_buffer_size 16k;
	fastcgi_buffers 16 16k;
	
	# ============================================================================
	
	# ngx_vts_module
	#vhost_traffic_status_zone;
	
	# tls dynamic records patch directive
	#ssl_dyn_rec_enable on;
	
	##
	# SSL Settings
	##
	
	# Enable 0-RTT support for TLS 1.3
	proxy_set_header Early-Data $ssl_early_data;
	ssl_early_data on;
	
	# enable http/2 and http/3
	http2 on;
	http3 on;
	
	# ============================================================================
	# SSL/TLS HARDENING
	# ============================================================================
	
	ssl_session_timeout 1d;
	ssl_session_cache shared:SSL:50m;
	ssl_session_tickets off;
	
	# Prefer server ciphers (server decides cipher order)
	ssl_prefer_server_ciphers on;
	
	# Only TLSv1.2 and TLSv1.3 (TLSv1.0/1.1 are vulnerable)
	ssl_protocols TLSv1.2 TLSv1.3;
	
	# Strong ciphers only - explicitly exclude weak ones
	# TLS 1.3 ciphers (automatically used, cannot be configured in nginx)
	# TLS 1.2 ciphers - only strong AEAD ciphers with ECDHE/DHE
	ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK:!DSS:!CAMELLIA:!SEED:!IDEA:!ADH:!AECDH';
	
	# Only strong ECDH curves (256-bit minimum)
	# X25519 = Curve25519 (256-bit, fast, secure)
	# P-521 = secp521r1 (521-bit)
	# P-384 = secp384r1 (384-bit)
	# P-256 = prime256v1/secp256r1 (256-bit)
	ssl_ecdh_curve X25519:secp521r1:secp384r1:prime256v1;
	
	# DH parameters (generate with: openssl dhparam -out /etc/nginx/dhparam.pem 4096)
	# ssl_dhparam /etc/nginx/dhparam.pem;
	
	# Common security headers
	more_set_headers "X-Frame-Options : SAMEORIGIN";
	more_set_headers "X-Content-Type-Options : nosniff";
	more_set_headers "Referrer-Policy : strict-origin-when-cross-origin";
	
	# OCSP Stapling settings
	resolver 8.8.8.8 1.1.1.1 8.8.4.4 1.0.0.1 valid=300s;
	resolver_timeout 10;
	ssl_stapling on;
	ssl_stapling_verify on;
	
	##
	# Basic Settings
	##
	# server_names_hash_bucket_size 64;
	# server_name_in_redirect off;
	
	include /etc/nginx/mime.types;
	default_type application/octet-stream;
	
	##
	# Logging Settings
	##
	
	access_log off;
	error_log /var/log/nginx/error.log;
	
	# Log format Settings
	log_format rt_cache '$remote_addr $upstream_response_time $upstream_cache_status [$time_local] '
	$host "$request" $status $body_bytes_sent '
	"$http_referer" "$http_user_agent" "$server_protocol" "$http3"';
	
	##
	# Security Maps (optimized pattern matching)
	##
	
	include snippets/secure-maps.conf;
	
	##
	# FastCGI Cache (optional - include if file exists)
	# Copy snippets/fastcgi-cache.conf to enable page caching
	##
	
	include snippets/fastcgi-cache.conf;
	
	##
	# Virtual Host Configs
	##
	
	include /etc/nginx/conf.d/*.conf;
	include /etc/nginx/sites-enabled/*;
}	
