#!/usr/sbin/nft -f

# =============================================================================
# NFTABLES FIREWALL - WordPress/Nginx Server
# =============================================================================
# Policy: DROP input/forward, ACCEPT output
# Services: SSH (22), HTTP (80), HTTPS (443 TCP+UDP)
# Protection: Rate limiting on SSH, ICMP, and HTTP/HTTPS flood
# Denylist: Auto-ban IPs exceeding HTTP rate limits for 30 minutes
# =============================================================================

flush ruleset

table inet filter {
    # =========================================================================
    # DENYLIST SETS - Auto-ban for 30 minutes (HTTP flood protection)
    # =========================================================================

    set denylist {
        type ipv4_addr
        flags dynamic, timeout
        timeout 30m
    }

    set denylist6 {
        type ipv6_addr
        flags dynamic, timeout
        timeout 30m
    }

    # =========================================================================
    # SETS FOR RATE LIMITING
    # =========================================================================
    
    # Set to track SSH connection attempts (for rate limiting)
    set ssh_meter {
        type ipv4_addr
        flags dynamic
        timeout 10s
    }
    
    set ssh_meter6 {
        type ipv6_addr
        flags dynamic
        timeout 10s
    }

    # =========================================================================
    # PREROUTING CHAIN (priority raw: -300)
    # =========================================================================
    # Runs BEFORE conntrack (-200)
    # Drop here = zero conntrack memory allocated for banned IPs
    # =========================================================================
    chain prerouting {
        type filter hook prerouting priority raw; policy accept;

        ip  saddr @denylist  counter drop
        ip6 saddr @denylist6 counter drop
    }

    # =========================================================================
    # INPUT CHAIN
    # =========================================================================
    chain input {
        type filter hook input priority filter; policy drop;

        # Accept loopback traffic
        iif "lo" accept

        # Accept established and related connections
        ct state established,related counter accept

        # Drop invalid connections
        ct state invalid counter drop

        # -----------------------------------------------------------------
        # ICMP/ICMPv6 - Rate limited ping
        # -----------------------------------------------------------------
        
        # IPv4: Accept ping with rate limit (1/second, burst 5)
        icmp type echo-request limit rate 1/second burst 5 packets counter accept

        # IPv6: Accept ping with rate limit (1/second, burst 5)
        icmpv6 type echo-request limit rate 1/second burst 5 packets counter accept

        # IPv6: Accept essential ICMPv6 messages (required for IPv6 to work)
        icmpv6 type { 
            destination-unreachable, 
            packet-too-big, 
            time-exceeded, 
            parameter-problem 
        } counter accept

        # -----------------------------------------------------------------
        # IPv6 Neighbor Discovery (ND) - Required for IPv6
        # -----------------------------------------------------------------
        icmpv6 type { 
            nd-router-solicit, 
            nd-router-advert, 
            nd-neighbor-solicit, 
            nd-neighbor-advert, 
            nd-redirect 
        } counter accept

        # -----------------------------------------------------------------
        # DHCP - Required for IPv4 dynamic addressing
        # -----------------------------------------------------------------
        # Accept DHCP responses (from server to client)
        udp sport 67 udp dport 68 counter accept

        # -----------------------------------------------------------------
        # SSH (Port 22) - Rate limited: max 10 new connections per 10 seconds
        # -----------------------------------------------------------------
        
        # IPv4 SSH rate limiting
        tcp dport 22 ct state new \
            add @ssh_meter { ip saddr limit rate over 10/minute burst 10 packets } \
            log prefix "SSH RATE LIMIT: " counter drop

        # IPv6 SSH rate limiting  
        tcp dport 22 ct state new \
            add @ssh_meter6 { ip6 saddr limit rate over 10/minute burst 10 packets } \
            log prefix "SSH6 RATE LIMIT: " counter drop

        # Accept SSH if not rate limited
        tcp dport 22 ct state new counter accept

        # -----------------------------------------------------------------
        # HTTP/HTTPS FLOOD PROTECTION
        # Rate limit: max 40 new TCP connections/minute (burst 30)
        # WordPress page â‰ˆ 70 HTTP requests, but via HTTP/2 = 1-2 TCP conns
        # HTTP/1.1 worst case = 6-8 TCP conns per page load
        # Exceeding IPs are added to denylist for 30 minutes
        # -----------------------------------------------------------------

        # IPv4 HTTP/HTTPS flood detection
        tcp dport { 80, 443 } ct state new \
            meter flood_v4 { ip saddr limit rate over 40/minute burst 30 packets } \
            add @denylist { ip saddr timeout 30m } \
            log prefix "HTTP FLOOD BAN: " counter drop

        # IPv6 HTTP/HTTPS flood detection
        tcp dport { 80, 443 } ct state new \
            meter flood_v6 { ip6 saddr limit rate over 40/minute burst 30 packets } \
            add @denylist6 { ip6 saddr timeout 30m } \
            log prefix "HTTP6 FLOOD BAN: " counter drop

        # -----------------------------------------------------------------
        # HTTP (Port 80) - Web traffic
        # -----------------------------------------------------------------
        tcp dport 80 counter accept

        # -----------------------------------------------------------------
        # HTTPS (Port 443) - Web traffic (TCP + UDP for HTTP/3 QUIC)
        # -----------------------------------------------------------------
        tcp dport 443 counter accept
        udp dport 443 counter accept

        # -----------------------------------------------------------------
        # LOGGING - Log dropped packets (optional, can be commented out)
        # -----------------------------------------------------------------
        # Limit logging to avoid log flooding
        limit rate 5/minute burst 10 packets log prefix "INPUT DROP: " counter drop

        # Final drop (implicit by policy, but explicit for clarity)
        counter drop
    }

    # =========================================================================
    # FORWARD CHAIN
    # =========================================================================
    chain forward {
        type filter hook forward priority filter; policy drop;
        
        # Log forwarded packets that are dropped
        limit rate 5/minute burst 10 packets log prefix "FORWARD DROP: " counter drop
    }

    # =========================================================================
    # OUTPUT CHAIN
    # =========================================================================
    chain output {
        type filter hook output priority filter; policy accept;
        
        # Accept all outgoing traffic (default policy)
    }
}