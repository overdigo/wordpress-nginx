#!/usr/sbin/nft -f

# =============================================================================
# NFTABLES FIREWALL - WordPress/Nginx Server
# =============================================================================
# Policy: DROP input/forward, ACCEPT output
# Services: SSH (22), HTTP (80), HTTPS (443 TCP+UDP)
# Protection: Rate limiting on SSH and ICMP
# =============================================================================

flush ruleset

table inet filter {
    # =========================================================================
    # SETS FOR RATE LIMITING
    # =========================================================================
    
    # Set to track SSH connection attempts (for rate limiting)
    set ssh_meter {
        type ipv4_addr
        flags dynamic
        timeout 10s
    }
    
    set ssh_meter6 {
        type ipv6_addr
        flags dynamic
        timeout 10s
    }

    # =========================================================================
    # INPUT CHAIN
    # =========================================================================
    chain input {
        type filter hook input priority filter; policy drop;

        # Accept loopback traffic
        iif "lo" accept

        # Accept established and related connections
        ct state established,related counter accept

        # Drop invalid connections
        ct state invalid counter drop

        # -----------------------------------------------------------------
        # ICMP/ICMPv6 - Rate limited ping
        # -----------------------------------------------------------------
        
        # IPv4: Accept ping with rate limit (1/second, burst 5)
        icmp type echo-request limit rate 1/second burst 5 packets counter accept

        # IPv6: Accept ping with rate limit (1/second, burst 5)
        icmpv6 type echo-request limit rate 1/second burst 5 packets counter accept

        # IPv6: Accept essential ICMPv6 messages (required for IPv6 to work)
        icmpv6 type { 
            destination-unreachable, 
            packet-too-big, 
            time-exceeded, 
            parameter-problem 
        } counter accept

        # -----------------------------------------------------------------
        # IPv6 Neighbor Discovery (ND) - Required for IPv6
        # -----------------------------------------------------------------
        icmpv6 type { 
            nd-router-solicit, 
            nd-router-advert, 
            nd-neighbor-solicit, 
            nd-neighbor-advert, 
            nd-redirect 
        } counter accept

        # -----------------------------------------------------------------
        # DHCP - Required for IPv4 dynamic addressing
        # -----------------------------------------------------------------
        # Accept DHCP responses (from server to client)
        udp sport 67 udp dport 68 counter accept

        # -----------------------------------------------------------------
        # SSH (Port 22) - Rate limited: max 10 new connections per 10 seconds
        # -----------------------------------------------------------------
        
        # IPv4 SSH rate limiting
        tcp dport 22 ct state new \
            add @ssh_meter { ip saddr limit rate over 10/minute burst 10 packets } \
            log prefix "SSH RATE LIMIT: " counter drop

        # IPv6 SSH rate limiting  
        tcp dport 22 ct state new \
            add @ssh_meter6 { ip6 saddr limit rate over 10/minute burst 10 packets } \
            log prefix "SSH6 RATE LIMIT: " counter drop

        # Accept SSH if not rate limited
        tcp dport 22 ct state new counter accept

        # -----------------------------------------------------------------
        # HTTP (Port 80) - Web traffic
        # -----------------------------------------------------------------
        tcp dport 80 counter accept

        # -----------------------------------------------------------------
        # HTTPS (Port 443) - Web traffic (TCP + UDP for HTTP/3 QUIC)
        # -----------------------------------------------------------------
        tcp dport 443 counter accept
        udp dport 443 counter accept

        # -----------------------------------------------------------------
        # LOGGING - Log dropped packets (optional, can be commented out)
        # -----------------------------------------------------------------
        # Limit logging to avoid log flooding
        limit rate 5/minute burst 10 packets log prefix "INPUT DROP: " counter drop

        # Final drop (implicit by policy, but explicit for clarity)
        counter drop
    }

    # =========================================================================
    # FORWARD CHAIN
    # =========================================================================
    chain forward {
        type filter hook forward priority filter; policy drop;
        
        # Log forwarded packets that are dropped
        limit rate 5/minute burst 10 packets log prefix "FORWARD DROP: " counter drop
    }

    # =========================================================================
    # OUTPUT CHAIN
    # =========================================================================
    chain output {
        type filter hook output priority filter; policy accept;
        
        # Accept all outgoing traffic (default policy)
    }
}