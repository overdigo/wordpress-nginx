[mysqld]
# =================================================================
# CONFIGURAÇÃO AUTOMÁTICA BASEADA EM RAM ({{TOTAL_RAM_MB}} MB)
# Servidor: {{DB_TYPE}} {{DB_VERSION}}
# Perfil: {{PROFILE}} 
# =================================================================

# Basic Settings
user = mysql
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
port = 3306
basedir = /usr
datadir = /var/lib/mysql
tmpdir = /tmp
bind-address = 127.0.0.1
skip_external_locking
skip_name_resolve

# =================================================================
# CONFIGURAÇÃO DE MEMÓRIA (RAM: {{TOTAL_RAM_MB}} MB)
# =================================================================

# InnoDB Buffer Pool (Principal alocação de memória)
# Armazena dados e índices em memória, reduzindo I/O de disco
# Calculado como ~70% da RAM disponível para o DB
innodb_buffer_pool_size = {{INNODB_BUFFER_POOL_SIZE}}

# Buffer Pool Instances (Concorrência)
# Múltiplas instâncias reduzem contenção de threads para pools > 1GB
innodb_buffer_pool_instances = {{INNODB_BUFFER_POOL_INSTANCES}}

# Chunk Size para redimensionamento dinâmico do pool
innodb_buffer_pool_chunk_size = {{INNODB_BUFFER_POOL_CHUNK_SIZE}}

# Log Buffer - Armazena informações de log de transação
innodb_log_buffer_size = {{INNODB_LOG_BUFFER_SIZE}}

# Redo Log (MySQL 8.0.30+)
{{INNODB_REDO_LOG_CONFIG}}

# =================================================================
# CONEXÕES E BUFFERS PER-THREAD
# =================================================================

# Limite de conexões concorrentes
max_connections = {{MAX_CONNECTIONS}}

# Thread cache
thread_stack = {{THREAD_STACK}}
thread_cache_size = {{THREAD_CACHE_SIZE}}

# Buffers de ordenação e junção (alocados por sessão)
sort_buffer_size = {{SORT_BUFFER_SIZE}}
join_buffer_size = {{JOIN_BUFFER_SIZE}}
read_buffer_size = {{READ_BUFFER_SIZE}}
read_rnd_buffer_size = {{READ_RND_BUFFER_SIZE}}

# =================================================================
# TABELAS TEMPORÁRIAS
# =================================================================

# MySQL usa o MENOR valor entre os dois
# Se exceder, migra para disco causando lentidão
tmp_table_size = {{TMP_TABLE_SIZE}}
max_heap_table_size = {{MAX_HEAP_TABLE_SIZE}}

# =================================================================
# CACHE DE TABELAS
# =================================================================

# Número de tabelas abertas (ideal: hit rate > 90%)
table_open_cache = {{TABLE_OPEN_CACHE}}
table_definition_cache = {{TABLE_DEFINITION_CACHE}}
{{TABLE_OPEN_CACHE_INSTANCES}}

# =================================================================
# OTIMIZAÇÃO DE I/O
# =================================================================

# Durabilidade vs Performance
# 1 = ACID compliant (mais seguro, mais I/O)
# 2 = Bom balanço (flush a cada 1s)
innodb_flush_log_at_trx_commit = {{INNODB_FLUSH_LOG_AT_TRX_COMMIT}}

# Método de flush para InnoDB
innodb_flush_method = O_DIRECT

# Um arquivo por tabela (melhor prática)
innodb_file_per_table = 1

# I/O Capacity
innodb_io_capacity = {{INNODB_IO_CAPACITY}}
{{INNODB_IO_CAPACITY_MAX}}

# Threads de I/O
innodb_read_io_threads = {{INNODB_READ_IO_THREADS}}
innodb_write_io_threads = {{INNODB_WRITE_IO_THREADS}}

# Arquivos abertos
innodb_open_files = {{INNODB_OPEN_FILES}}

# Otimizações adicionais
innodb_stats_on_metadata = 0
{{INNODB_FLUSH_NEIGHBORS}}
{{INNODB_LRU_SCAN_DEPTH}}

# =================================================================
# MyISAM (Manter pequeno se usar apenas InnoDB)
# =================================================================

key_buffer_size = {{KEY_BUFFER_SIZE}}
myisam_sort_buffer_size = {{MYISAM_SORT_BUFFER_SIZE}}

# =================================================================
# PACOTES E SEGURANÇA
# =================================================================

max_allowed_packet = {{MAX_ALLOWED_PACKET}}
local_infile = 0
skip-symbolic-links = 1
secure_file_priv = /var/lib/mysql-files

# =================================================================
# LOGGING
# =================================================================

log_error = /var/log/mysql/error.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = {{LONG_QUERY_TIME}}
log_queries_not_using_indexes = ON

# =================================================================
# PERFORMANCE SCHEMA (apenas para servidores grandes)
# =================================================================
{{PERFORMANCE_SCHEMA_CONFIG}}

[mysqld_safe]
log-error = /var/log/mysql/error.log
pid-file = /var/run/mysqld/mysqld.pid

[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
